<html>  
    <head>
        <meta charset="utf-8"/>
        <style>
          div#ui > div {
            margin-bottom: 16px;
          }

          div#ui > div#notifications {
            color: darkred;
          }

          div#ui > div#notifications > p:last-child {
            border-bottom: 1px solid darkblue;
          }

          div#ui > div#player {
            padding: 8px;
            border: 1px solid black;
          }

          div#ui > div#player > div#actions {
            margin-top: 16px;
          }
        </style>
        <script src="wasm_exec.js"></script>
        <script>
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("game.wasm"), go.importObject).then((result) => {
                go.run(result.instance);
            });
        </script>
    </head>
    <body>
      <div id="ui">
        <div id="notifications"></div>
        <div id="room">
          <div class="content"></div>
        </div>
        <div id="player">
          <div class="content"></div>
          <div id="actions"></div>
        </div>
      </div>

      <script>
        const render = function() {
          const notifications = document.querySelector("#ui > #notifications");
          const room = document.querySelector("#ui > #room > .content");
          const player = document.querySelector("#ui > #player > .content");
          const actionsContainer = document.querySelector("#ui > #player > #actions");

          const renderNotification = function(notification) {
            const node = document.createElement("p");
            node.innerText = notification;
            notifications.appendChild(node);
          };

          const renderRoom = function() {
            room.innerText = state.currentRoom.description;

            actionsContainer.innerHTML = '';

            for (const act of state.currentRoom.actions) {
              let button = document.createElement("button");
              button.textContent = act.it;
              button.onclick = action(act.do, [act.to]);

              actionsContainer.appendChild(button);
            }
          };

          const inventoryString = function(inventory) {
            let str = '';

            for (let [id, item] of Object.entries(inventory)) {
              str += `\n- ${item.name}: ${item.description}`;
            }
            
            if (str.length === 0) {
              return 'nothing but the fear in the pit of your stomach';
            }

            return str;
          }

          const renderPlayer = function() {
            player.innerText = `Inventory: ${inventoryString(state.player.inventory)}`
          }

          const action = function(event, ids) {
            return function(_evt) {
              window.state = JSON.parse(GameLoop(event, ids.length, ...ids));

              notifications.innerHTML = '';
              for (const notification of state.notifications) {
                renderNotification(notification);
              }

              renderRoom()
              renderPlayer()
            }
          };

          window.state = JSON.parse(NewState());
          renderRoom();
        }

        setTimeout(render, 250)
      </script>
    </body>
</html>  
