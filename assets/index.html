<html>  
    <head>
        <meta charset="utf-8"/>
        <style>
          div#ui > div {
            margin-bottom: 16px;
          }

          div#ui > div#notifications {
            color: darkred;
          }

          div#ui > div#notifications > p:last-child {
            border-bottom: 1px solid darkblue;
          }

          div#ui > div#player {
            padding: 8px;
            border: 1px solid black;
          }
          
          div#ui > div#player > div#actions {
            margin-top: 16px;
          }

          .hidden {
            display: none;
          }

          button {
            border: 1px solid black;
            background-color: white;
            padding: 0.5em;
            margin-left: 0.2em;
            margin-right: 0.2em;
          }
        </style>
        <script src="wasm_exec.js"></script>
        <script>
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("game.wasm"), go.importObject).then((result) => {
                go.run(result.instance);
            });
        </script>
    </head>
    <body>
      <div id="ui">
        <div id="notifications"></div>
        <div id="room">
          <div class="content"></div>
          <div class="checkbox-array hidden">
            <input type="checkbox" id="checkbox-0" />
            <input type="checkbox" id="checkbox-1" />
            <input type="checkbox" id="checkbox-2" />
            <input type="checkbox" id="checkbox-3" />
            <br>
            <input type="checkbox" id="checkbox-4" />
            <input type="checkbox" id="checkbox-5" />
            <input type="checkbox" id="checkbox-6" />
            <input type="checkbox" id="checkbox-7" />
            <br>
            <button id="checkbox-button" onclick="openBox()">Open box</button>
          </div>
        </div>
        <div id="player">
          <div class="content"></div>
          <p>Inventory</p>
          <select multiple class="hidden" id="inventory"></select>
          <div id="actions"></div>
        </div>
      </div>

      <script>
        const render = function() {
          const notifications = document.querySelector("#ui > #notifications");
          const room = document.querySelector("#ui > #room > .content");
          const checkboxArray = document.querySelector("#ui > #room > .checkbox-array");
          const player = document.querySelector("#ui > #player > .content");
          const inventory = document.querySelector("#ui > #player > #inventory");
          const actionsContainer = document.querySelector("#ui > #player > #actions");

          const renderNotification = function(notification) {
            const node = document.createElement("p");
            node.innerText = notification;
            notifications.appendChild(node);
          };

          const displayCheckboxArray = function() {
            checkboxArray.classList.remove("hidden")
          }

          const destroyCheckboxArray = function() {
            checkboxArray.classList.add("hidden")
          }

          const renderRoom = function() {
            room.innerText = state.currentRoom.description;

            actionsContainer.innerHTML = '';

            if (Object.keys(state.player.inventory).length > 0) {
              actionsContainer.appendChild(useItemsAction());
            }

            for (const act of state.currentRoom.actions) {
              let button = document.createElement("button");
              button.textContent = act.it;
              button.onclick = action(act.do, [act.to]);

              actionsContainer.appendChild(button);
            }

            if (state.currentRoom.properties.checkboxes) {
              displayCheckboxArray();
            } else {
              destroyCheckboxArray();
            }
          };

          const renderInventory = function() {
            inventory.innerText = '';

            if (Object.keys(state.player.inventory).length == 0) {
              inventory.classList.add("hidden")
              console.log("Inventory hidden");
            } else {
              inventory.classList.remove("hidden");
              console.log("Inventory no longer hidden");
            }

            for (let [id, item] of Object.entries(state.player.inventory)) {
              let option = document.createElement("option");
              option.value = id;
              option.innerText = `${item.name}: ${item.description}`;
              inventory.appendChild(option);
            }
          }

          const action = function(event, ids) {
            return function(_evt) {
              window.state = JSON.parse(GameLoop(event, ids.length, ...ids));

              notifications.innerHTML = '';
              for (const notification of state.notifications) {
                renderNotification(notification);
              }

              renderRoom()
              renderInventory()
            }
          };

          const useItemsAction = function() {
            const selected = inventory.selectedOptions;

            let ids = [];
            for (let i = 0; i < selected.length; i++) {
              ids.push(parseInt(selected[i].value));
            }

            const btn = document.createElement("button");
            btn.textContent = "Use item(s)";
            btn.onclick = action("useItems", ids);

            return btn;
          }

          window.openBox = function() {
            const selected = checkboxArray.querySelectorAll("input");
            let values = [];
            for (let i = 0; i < selected.length; i++) {
              values.push(selected[i].checked ? 1 : 0);
            }

            action("openBox", values)();
          }

          window.state = JSON.parse(NewState());
          renderRoom();
        }

        setTimeout(render, 250)
      </script>
    </body>
</html>  
